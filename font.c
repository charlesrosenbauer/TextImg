#include "stdint.h"
#include "stdlib.h"
#include "stdio.h"

#include "img.h"

#ifdef __WASM__
#include <emscripten.h>
#endif

#include "util.h"





DataImg initDataImg(int h, int w){
	DataImg img;
	int size	= h * w;
	img.pxl		= malloc(sizeof(uint32_t) * size);
	img.data	= malloc(sizeof( int32_t) * size);
	img.h		= h;
	img.w		= w;
	img.vx		= w / 2;
	img.vy		= h / 2;
	img.zoom	= 0;
	for(int i = 0; i < size; i++) img.pxl [i] = 0;
	for(int i = 0; i < size; i++) img.data[i] = 0;
	return img;
}

DataImg randomizeDataImg(DataImg img){
	for(int i = 0; i < img.h; i++){
		for(int j = 0; j < img.w; j++){
			int n = (i * img.w) + j;
			img.pxl [n] = rng();
			img.data[n] = 0;
		}
	}
	return img;
}


void drawDataImg(Img img, DataImg dimg, int x, int y, int h, int w){
	// FIXME : handle negative zoom, debug this
	int vx = dimg.vx - (w >> (dimg.zoom+1));
	int vy = dimg.vy - (h >> (dimg.zoom+1));
	for(int i  = 0; i < h; i++){
		int ny = vy + (i >> dimg.zoom);
		if((ny < 0) || (ny >= dimg.h)){
			for(int j = 0; j < w; j++){
				int p = ((i+y) *  img.w) + j + x;
				img.pixels[p] = 0x070707;
			}
		}else{
			for(int j = 0; j < w; j++){
				int nx = vx + (j >> dimg.zoom);
				int p  = ((i+y) *  img.w) + j + x;
				if((nx < 0) || (nx >= dimg.w)){
					img.pixels[p] = 0x070707;
				}else{
					int n  = (ny    * dimg.w) + nx;
					img.pixels[p] = dimg.pxl[n];
				}
			}
		}
	}
}

int32_t clickDataImg(DataImg dimg, int x, int y, int h, int w){
	int vx = dimg.vx - (w >> (dimg.zoom+1));
	int vy = dimg.vy - (h >> (dimg.zoom+1));
	int ny = vy + (y >> dimg.zoom);
	int nx = vx + (x >> dimg.zoom);
	if((nx < 0) || (ny < 0) || (nx >= dimg.w) || (ny >= dimg.h)) return 0;
	return dimg.data[(ny * dimg.w) + nx];
}


int rectCheck(int mx, int my, int x, int y, int h, int w){
	return ((mx >= x) && (mx < (x+w)) && (my >= y) && (my < (y+h)));
}


void printFillDataImg(DataImg dimg){
	for(int i = 0; i < dimg.h; i++){
		for(int j = 0; j < dimg.w; j++){
			int n = (dimg.w * i) + j;
			printf("%c", dimg.pxl[n]? '#' : ' ');
		}
		printf("\n");
	}
}

void printMarkDataImg(DataImg dimg, int markX, int markY){
	for(int i = 0; i < dimg.h; i++){
		for(int j = 0; j < dimg.w; j++){
			int n = (dimg.w * i) + j;
			if((i != markY) || (j != markX))
				printf("%c", dimg.pxl[n]? '#' : ' ');
			else
				printf("O");
		}
		printf("\n");
	}
}




ColorPalette defaultPalette(){
	ColorPalette ret;
	ret.colors[ 0] = 0x2c2c2c;
	ret.colors[ 1] = 0x3f3b38;
	ret.colors[ 2] = 0x514c47;
	ret.colors[ 3] = 0x7a7261;
	
	ret.colors[ 4] = 0xff0000;
	ret.colors[ 5] = 0xff6a00;
	ret.colors[ 6] = 0xf6ba00;
	ret.colors[ 7] = 0x68ca71;
	
	ret.colors[ 8] = 0xa4be23;
	ret.colors[ 9] = 0x389696;
	ret.colors[10] = 0xc87ab9;
	ret.colors[11] = 0xefcf6c;
	
	ret.colors[12] = 0;
	ret.colors[13] = 0;
	ret.colors[14] = 0;
	ret.colors[15] = 0;
	return ret;
}



Img makeFont(){
	Img ret;
	ret.h = 192;
	ret.w = 128;
	ret.pixels = malloc(sizeof(uint32_t) * ret.h * ret.w);
	
	char* text = "\
\x00\x00\x00\x00\x00\x00\x00\x00\xff\x00\xff\x00\x00\x00\x00\x00\x00\x7e\x7e\x00\x08\x18\x18\x00\xff\x00\xff\x7c\x3c\xf8\xfe\x00\
\x00\xc3\xff\x22\x1c\x3c\x3c\x00\xff\x3c\xc3\x70\x66\x98\xc6\x18\x00\x81\xff\x77\x3e\x3c\x7e\x00\xff\x7e\x81\x5c\x66\x98\xfe\xdb\
\x00\xa5\xdb\x7f\x7f\xff\xff\x3c\xc3\x66\x99\x4e\x66\xf8\xc6\x7e\x00\x81\xff\x7f\x7f\xe7\xff\x7e\x81\x42\xbd\x1f\x3c\x18\xc6\xe7\
\x00\xbd\xc3\x7f\x3e\xe7\x7e\x7e\x81\x42\xbd\x33\x18\x18\xc6\xe7\x00\x99\xe7\x3e\x1c\x18\x18\x3c\xc3\x66\x99\x33\x7e\x1e\xe6\x7e\
\x00\xc3\xff\x1c\x08\x18\x18\x00\xff\x7e\x81\x33\x18\x1f\xe7\xdb\x00\x7e\x7e\x08\x00\x7e\x7e\x00\xff\x3c\xc3\x1e\x18\x0e\x67\x18\
\x00\x00\x00\x00\x00\x00\x00\x00\xff\x00\xff\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x00\xff\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x40\x18\x66\xfe\x7e\x00\x18\x18\x18\x00\x00\x00\x00\x00\x00\
\x03\x60\x3c\x66\xdb\xc6\x00\x3c\x3c\x18\x00\x00\x00\x00\x08\x7f\x07\x70\x7e\x66\xdb\x0c\x00\x7e\x7e\x18\x18\x0c\x00\x24\x08\x7f\
\x1f\x7c\x18\x66\xdb\x3c\x00\x18\x18\x18\x30\x06\x03\x66\x1c\x3e\x7f\x7f\x18\x66\xde\x66\x00\x18\x18\x18\x7f\x7f\x03\xff\x1c\x3e\
\x1f\x7c\x18\x00\xd8\x66\x00\x18\x18\x18\x30\x06\x03\x66\x3e\x1c\x07\x70\x7e\x00\xd8\x3c\x7f\x7e\x18\x7e\x18\x0c\x7f\x24\x3e\x1c\
\x03\x60\x3c\x66\xd8\x30\x7f\x3c\x18\x3c\x00\x00\x00\x00\x7f\x08\x01\x40\x18\x66\xd8\x63\x7f\x18\x18\x18\x00\x00\x00\x00\x7f\x08\
\x00\x00\x00\x00\x00\x7e\x00\x7e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0c\x66\x36\x0c\x00\x0e\x0c\x30\x06\x00\x00\x00\x00\x00\x00\
\x00\x1e\x66\x36\x3e\x00\x1b\x0c\x18\x0c\x00\x00\x00\x00\x00\x40\x00\x1e\x66\x7f\x03\x23\x1b\x0c\x0c\x18\x66\x18\x00\x00\x00\x60\
\x00\x1e\x24\x36\x03\x33\x0e\x06\x06\x30\x3c\x18\x00\x00\x00\x30\x00\x0c\x00\x36\x1e\x18\x5f\x00\x06\x30\xff\x7e\x00\x7f\x00\x18\
\x00\x0c\x00\x36\x30\x0c\x7b\x00\x06\x30\x3c\x18\x00\x00\x00\x0c\x00\x00\x00\x7f\x30\x06\x33\x00\x0c\x18\x66\x18\x00\x00\x00\x06\
\x00\x0c\x00\x36\x1f\x33\x3b\x00\x18\x0c\x00\x00\x1c\x00\x1c\x03\x00\x0c\x00\x36\x0c\x31\x6e\x00\x30\x06\x00\x00\x1c\x00\x1c\x01\
\x00\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3e\x08\x1e\x1e\x30\x3f\x1c\x7f\x1e\x1e\x00\x00\x30\x00\x06\x1e\
\x63\x0c\x33\x33\x38\x03\x06\x63\x33\x33\x00\x00\x18\x00\x0c\x33\x73\x0f\x33\x30\x3c\x03\x03\x63\x33\x33\x1c\x1c\x0c\x00\x18\x30\
\x7b\x0c\x30\x30\x36\x03\x03\x60\x37\x33\x1c\x1c\x06\x7e\x30\x18\x6b\x0c\x18\x1c\x33\x1f\x1f\x30\x1e\x3e\x00\x00\x03\x00\x60\x0c\
\x6f\x0c\x0c\x30\x7f\x30\x33\x18\x3b\x18\x00\x00\x06\x7e\x30\x0c\x67\x0c\x06\x30\x30\x30\x33\x0c\x33\x18\x1c\x1c\x0c\x00\x18\x00\
\x63\x0c\x33\x33\x30\x33\x33\x0c\x33\x0c\x1c\x1c\x18\x00\x0c\x0c\x3e\x3f\x3f\x1e\x78\x1e\x1e\x0c\x1e\x0e\x00\x18\x30\x00\x06\x0c\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3e\x0c\x3f\x3c\x1f\x7f\x7f\x3c\x33\x1e\x78\x67\x0f\x63\x63\x1c\
\x63\x1e\x66\x66\x36\x46\x66\x66\x33\x0c\x30\x66\x06\x77\x63\x36\x63\x33\x66\x63\x66\x06\x46\x63\x33\x0c\x30\x36\x06\x7f\x67\x63\
\x7b\x33\x66\x03\x66\x26\x26\x03\x33\x0c\x30\x36\x06\x7f\x6f\x63\x7b\x33\x3e\x03\x66\x3e\x3e\x03\x3f\x0c\x30\x1e\x06\x6b\x7f\x63\
\x7b\x3f\x66\x03\x66\x26\x26\x73\x33\x0c\x33\x36\x46\x63\x7b\x63\x03\x33\x66\x63\x66\x06\x06\x63\x33\x0c\x33\x36\x66\x63\x73\x63\
\x03\x33\x66\x66\x36\x46\x06\x66\x33\x0c\x33\x66\x66\x63\x63\x36\x3e\x33\x3f\x3c\x1f\x7f\x0f\x7c\x33\x1e\x1e\x67\x7f\x63\x63\x1c\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x3f\x1c\x3f\x1e\x3f\x33\x33\x63\x33\x33\x7f\x3c\x00\x3c\x1c\x00\
\x66\x36\x66\x33\x2d\x33\x33\x63\x33\x33\x73\x0c\x01\x30\x36\x00\x66\x63\x66\x33\x0c\x33\x33\x63\x33\x33\x19\x0c\x03\x30\x63\x00\
\x66\x63\x66\x03\x0c\x33\x33\x63\x1e\x33\x18\x0c\x06\x30\x00\x00\x3e\x63\x3e\x0e\x0c\x33\x33\x6b\x0c\x1e\x0c\x0c\x0c\x30\x00\x00\
\x06\x73\x36\x18\x0c\x33\x33\x6b\x1e\x0c\x06\x0c\x18\x30\x00\x00\x06\x7b\x66\x33\x0c\x33\x33\x36\x33\x0c\x46\x0c\x30\x30\x00\x00\
\x06\x3e\x66\x33\x0c\x33\x1e\x36\x33\x0c\x63\x0c\x60\x30\x00\x00\x0f\x30\x67\x1e\x1e\x1e\x0c\x36\x33\x1e\x7f\x3c\x40\x3c\x00\x00\
\x00\x78\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0c\x00\x07\x00\x38\x00\x1c\x00\x07\x18\x30\x07\x1e\x00\x00\x00\
\x18\x00\x06\x00\x30\x00\x36\x00\x06\x18\x30\x06\x18\x00\x00\x00\x00\x00\x06\x00\x30\x00\x06\x00\x06\x00\x00\x06\x18\x00\x00\x00\
\x00\x1e\x3e\x1e\x3e\x1e\x06\x6e\x36\x1e\x3c\x66\x18\x3f\x1f\x1e\x00\x30\x66\x33\x33\x33\x1f\x33\x6e\x18\x30\x36\x18\x6b\x33\x33\
\x00\x3e\x66\x03\x33\x3f\x06\x33\x66\x18\x30\x1e\x18\x6b\x33\x33\x00\x33\x66\x03\x33\x03\x06\x33\x66\x18\x30\x36\x18\x6b\x33\x33\
\x00\x33\x66\x33\x33\x33\x06\x3e\x66\x18\x30\x66\x18\x6b\x33\x33\x00\x6e\x3b\x1e\x6e\x1e\x0f\x30\x67\x7e\x33\x67\x7e\x63\x33\x1e\
\x00\x00\x00\x00\x00\x00\x00\x33\x00\x00\x33\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1e\x00\x00\x1e\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x38\x18\x07\xce\x00\
\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x0c\x18\x0c\x5b\x00\x00\x00\x00\x00\x06\x00\x00\x00\x00\x00\x00\x0c\x18\x0c\x73\x08\
\x3b\x6e\x37\x1e\x3f\x33\x33\x63\x63\x66\x3f\x06\x18\x18\x00\x1c\x66\x33\x76\x33\x06\x33\x33\x63\x36\x66\x31\x03\x00\x30\x00\x36\
\x66\x33\x6e\x06\x06\x33\x33\x6b\x1c\x66\x18\x06\x18\x18\x00\x63\x66\x33\x06\x18\x06\x33\x33\x6b\x1c\x66\x06\x0c\x18\x0c\x00\x63\
\x66\x33\x06\x33\x36\x33\x1e\x36\x36\x3c\x23\x0c\x18\x0c\x00\x7f\x3e\x3e\x0f\x1e\x1c\x6e\x0c\x36\x63\x30\x3f\x38\x18\x07\x00\x00\
\x06\x30\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x0f\x78\x00\x00\x00\x00\x00\x00\x00\x0f\x00\x00\x00\x00\x00\x00\
\x00\x00\x30\x0c\x00\x03\x1c\x00\x0c\x00\x03\x00\x08\x06\x00\x1e\x1e\x33\x18\x1e\x33\x06\x36\x00\x1e\x33\x06\x36\x1c\x0c\x33\x33\
\x33\x33\x0c\x33\x33\x0c\x36\x00\x33\x33\x0c\x36\x36\x18\x00\x33\x33\x00\x00\x00\x00\x00\x1c\x00\x00\x00\x00\x00\x00\x00\x0c\x1e\
\x03\x33\x1e\x1e\x1e\x1e\x1f\x1e\x1e\x1e\x1e\x1e\x1e\x1e\x1e\x1e\x03\x33\x33\x30\x30\x30\x30\x33\x33\x33\x33\x18\x18\x18\x33\x33\
\x03\x33\x3f\x3e\x3e\x3e\x3e\x03\x3f\x3f\x3f\x18\x18\x18\x33\x33\x33\x33\x03\x33\x33\x33\x33\x03\x03\x03\x03\x18\x18\x18\x3f\x3f\
\x33\x33\x33\x33\x33\x33\x33\x33\x03\x03\x03\x18\x18\x18\x33\x33\x1e\x6e\x1e\x6e\x6e\x6e\x6e\x1e\x3e\x3e\x3e\x7e\x7e\x7e\x33\x33\
\x0c\x00\x00\x00\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x0f\x00\x00\x00\x00\x00\x00\x0f\x00\x00\x00\x00\x00\x00\x00\x00\
\x30\x00\x00\x0c\x00\x03\x0c\x03\x00\x33\x33\x00\x3c\x33\x0f\x70\x18\x00\x7c\x1e\x33\x06\x1e\x06\x66\x00\x00\x0c\x66\x33\x11\xd8\
\x0c\x00\x1e\x33\x33\x0c\x33\x0c\x66\x1e\x33\x0c\x06\x33\x11\x18\x3f\x00\x1b\x00\x00\x00\x00\x00\x00\x33\x33\x1e\x06\x33\x11\x18\
\x23\x7f\x1b\x1e\x1e\x1e\x33\x33\x66\x33\x33\x33\x06\x1e\x0f\x7e\x03\xd8\x7f\x33\x33\x33\x33\x33\x66\x33\x33\x03\x3f\x3f\x11\x18\
\x1f\xfe\x1b\x33\x33\x33\x33\x33\x66\x33\x33\x03\x06\x0c\x79\x18\x03\x1b\x1b\x33\x33\x33\x33\x33\x66\x33\x33\x33\x06\x3f\x31\x18\
\x23\x1b\x1b\x33\x33\x33\x33\x33\x3c\x33\x33\x1e\x03\x0c\xb1\x1b\x3f\xf7\x7b\x1e\x1e\x1e\x6e\x6e\x30\x1e\x1e\x0c\x7f\x0c\x61\x0e\
\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\x00\x00\x00\x00\x00\x00\x00\
\x30\x30\x30\x30\x00\x6e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x18\x18\x18\x6e\x3b\x1e\x1e\x0c\x00\x00\x42\xc6\x0c\x00\x00\
\x0c\x0c\x0c\x0c\x3b\x00\x33\x33\x0c\x00\x00\x63\x67\x0c\x00\x00\x00\x00\x00\x00\x00\x63\x33\x33\x00\x00\x00\x33\x36\x00\x00\x00\
\x1e\x1e\x1e\x33\x1f\x67\x7e\x1e\x0c\x00\x00\x1b\x1e\x0c\xcc\x33\x30\x18\x33\x33\x33\x6f\x00\x00\x06\x3f\x3f\x0c\xec\x0c\x66\x66\
\x3e\x18\x33\x33\x33\x7b\x7f\x7f\x03\x03\x30\x76\xf6\x1e\x33\xcc\x33\x18\x33\x33\x33\x73\x00\x00\x03\x03\x30\xc3\xdb\x1e\x33\xcc\
\x33\x18\x33\x33\x33\x63\x00\x00\x33\x03\x30\x61\xcd\x1e\x66\x66\x6e\x7e\x1e\x6e\x33\x63\x00\x00\x1e\x00\x00\x30\xfc\x0c\xcc\x33\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x24\xaa\xb6\x18\x18\x18\x66\x00\x00\x66\x66\x00\x66\x66\x18\x00\x49\x55\xdb\x18\x18\x18\x66\x00\x00\x66\x66\x00\x66\x66\x18\x00\
\x92\xaa\x6d\x18\x18\x18\x66\x00\x00\x66\x66\x00\x66\x66\x18\x00\x24\x55\xb6\x18\x18\x18\x66\x00\x00\x66\x66\x00\x66\x66\x18\x00\
\x49\xaa\xdb\x18\x18\x1f\x66\x00\x1f\x67\x66\x7f\x67\x66\x1f\x00\x92\x55\x6d\x18\x1f\x18\x67\x7f\x18\x60\x66\x60\x60\x7f\x18\x1f\
\x24\xaa\xb6\x18\x18\x18\x66\x66\x18\x60\x66\x60\x60\x00\x18\x18\x49\x55\xdb\x18\x18\x1f\x66\x66\x1f\x67\x66\x67\x7f\x00\x1f\x18\
\x92\xaa\x6d\x18\x18\x18\x66\x66\x18\x66\x66\x66\x00\x00\x00\x18\x24\x55\xb6\x18\x18\x18\x66\x66\x18\x66\x66\x66\x00\x00\x00\x18\
\x49\xaa\xdb\x18\x18\x18\x66\x66\x18\x66\x66\x66\x00\x00\x00\x18\x92\x55\x6d\x18\x18\x18\x66\x66\x18\x66\x66\x66\x00\x00\x00\x18\
\x18\x18\x00\x18\x00\x18\x18\x66\x66\x00\x66\x00\x66\x00\x66\x18\x18\x18\x00\x18\x00\x18\x18\x66\x66\x00\x66\x00\x66\x00\x66\x18\
\x18\x18\x00\x18\x00\x18\x18\x66\x66\x00\x66\x00\x66\x00\x66\x18\x18\x18\x00\x18\x00\x18\x18\x66\x66\x00\x66\x00\x66\x00\x66\x18\
\x18\x18\x00\x18\x00\x18\xf8\x66\xe6\xfe\xe7\xff\xe6\xff\xe7\xff\xf8\xff\xff\xf8\xff\xff\x18\xe6\x06\x06\x00\x00\x06\x00\x00\x00\
\x00\x00\x18\x18\x00\x18\x18\x66\x06\x06\x00\x00\x06\x00\x00\x00\x00\x00\x18\x18\x00\x18\xf8\x66\xfe\xe6\xff\xe7\xe6\xff\xe7\xff\
\x00\x00\x18\x18\x00\x18\x18\x66\x00\x66\x00\x66\x66\x00\x66\x00\x00\x00\x18\x18\x00\x18\x18\x66\x00\x66\x00\x66\x66\x00\x66\x00\
\x00\x00\x18\x18\x00\x18\x18\x66\x00\x66\x00\x66\x66\x00\x66\x00\x00\x00\x18\x18\x00\x18\x18\x66\x00\x66\x00\x66\x66\x00\x66\x00\
\x66\x00\x00\x66\x18\x00\x00\x66\x18\x18\x00\xff\x00\x0f\xf0\xff\x66\x00\x00\x66\x18\x00\x00\x66\x18\x18\x00\xff\x00\x0f\xf0\xff\
\x66\x00\x00\x66\x18\x00\x00\x66\x18\x18\x00\xff\x00\x0f\xf0\xff\x66\x00\x00\x66\x18\x00\x00\x66\x18\x18\x00\xff\x00\x0f\xf0\xff\
\x66\xff\x00\x66\xf8\xf8\x00\x66\xff\x18\x00\xff\x00\x0f\xf0\xff\xff\x00\xff\xfe\x18\x18\xfe\xe7\x00\x1f\xf8\xff\x00\x0f\xf0\xff\
\x00\x00\x66\x00\x18\x18\x66\x66\x00\x00\x18\xff\xff\x0f\xf0\x00\x00\xff\x66\x00\xf8\xf8\x66\x66\xff\x00\x18\xff\xff\x0f\xf0\x00\
\x00\x18\x66\x00\x00\x18\x66\x66\x18\x00\x18\xff\xff\x0f\xf0\x00\x00\x18\x66\x00\x00\x18\x66\x66\x18\x00\x18\xff\xff\x0f\xf0\x00\
\x00\x18\x66\x00\x00\x18\x66\x66\x18\x00\x18\xff\xff\x0f\xf0\x00\x00\x18\x66\x00\x00\x18\x66\x66\x18\x00\x18\xff\xff\x0f\xf0\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1e\x3f\x7f\x3f\x00\x00\x00\x3f\x1e\x3e\x3c\x00\x00\x3c\x00\
\x00\x33\x33\x36\x23\x00\x00\x00\x0c\x33\x63\x06\x00\x60\x06\x1e\x00\x33\x33\x36\x26\x00\x00\x6e\x1e\x33\x63\x0c\x6e\x3e\x03\x33\
\x6e\x1b\x03\x36\x06\x7e\x66\x3b\x33\x33\x63\x1e\xdb\x7b\x03\x33\x7b\x33\x03\x36\x0c\x13\x66\x18\x33\x3f\x63\x33\xdb\x6b\x3f\x33\
\x33\x33\x03\x36\x06\x33\x66\x18\x33\x33\x36\x33\xdb\x6f\x03\x33\x33\x33\x03\x36\x26\x33\x66\x18\x1e\x33\x36\x33\x76\x3e\x03\x33\
\x7b\x1f\x03\x36\x23\x33\x66\x18\x0c\x33\x36\x33\x00\x03\x06\x33\x6e\x03\x03\x66\x3f\x1e\xde\x70\x3f\x1e\x77\x1e\x00\x00\x3c\x33\
\x00\x06\x00\x00\x00\x00\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06\x18\x00\x18\x00\x00\x3c\x00\x00\xe0\x1b\x1e\x00\x00\
\x3f\x0c\x0c\x0c\x70\x18\x0c\xce\x66\x00\x00\x20\x36\x30\x3c\x00\x00\x0c\x18\x06\xd8\x18\x0c\xdb\x66\x00\x00\x20\x36\x18\x3c\x00\
\x00\x3f\x18\x06\xd8\x18\x00\x73\x66\x38\x00\x20\x36\x0c\x3c\x00\x3f\x0c\x0c\x0c\x18\x18\x3f\x00\x3c\x38\x18\x22\x36\x3e\x3c\x00\
\x00\x0c\x06\x18\x18\x18\x00\xce\x00\x00\x00\x26\x00\x00\x3c\x00\x00\x00\x00\x00\x18\x1b\x0c\xdb\x00\x00\x00\x2c\x00\x00\x3c\x00\
\x3f\x3f\x3f\x3f\x18\x1b\x0c\x73\x00\x00\x00\x38\x00\x00\x3c\x00\x00\x00\x00\x00\x18\x0e\x00\x00\x00\x00\x00\x30\x00\x00\x3c\x00\
\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";
	uint8_t* xs = (uint8_t*)text;
	for(int i = 0; i < ret.h * ret.w; i++)
		ret.pixels[i] = (xs[i/8] & (1 << (i%8)))? 0xffffffff : 0;
	
	return ret;
}




void drawChar(Img img, Img font, uint8_t c, int fx, int fy){
	int cy = (c >> 4) * 12;
	int cx = (c & 0xf) * 8;

	for(int i = 0; i < 12; i++){
		int y = fy + i;
		if( y >= img.h ) return;
		for(int j = 0; j < 8; j++){
			int x = fx + j;
			if( x >= img.w ) continue;
			int n = (y * img.w) + x;
			int m = ((i + cy) * 128) + j + cx;
			img.pixels[n] = font.pixels[m]?  font.pixels[m] : img.pixels[n];
		}
	}
}

void drawColorChar(Img img, Img font, uint8_t c, int fx, int fy, uint32_t fg, uint32_t bg){
	int cy = (c >> 4) * 12;
	int cx = (c & 0xf) * 8;

	if(bg){
		for(int i = 0; i < 12; i++){
			int y = fy + i;
			if( y > img.h ) return;
			for(int j = 0; j < 8; j++){
				int x = fx + j;
				if( x > img.w ) continue;
				int n = (y * img.w) + x;
				int m = ((i + cy) * 128) + j + cx;
				img.pixels[n] = font.pixels[m]? font.pixels[m]&fg : bg;
			}
		}
	}else{
		for(int i = 0; i < 12; i++){
			int y = fy + i;
			if( y > img.h ) return;
			for(int j = 0; j < 8; j++){
				int x = fx + j;
				if( x > img.w ) continue;
				int n = (y * img.w) + x;
				int m = ((i + cy) * 128) + j + cx;
				img.pixels[n] = font.pixels[m]? font.pixels[m]&fg : img.pixels[n];
			}
		}
	}
}


void drawColorCharFlat(Img img, Img font, uint8_t c, int fx, int fy, uint32_t fg, uint32_t bg){
	int cy = (c >> 4) * 12;
	int cx = (c & 0xf) * 8;

	for(int i = 0; i < 12; i++){
		int y = fy + i;
		if( y > img.h ) return;
		for(int j = 0; j < 8; j++){
			int x = fx + j;
			if( x > img.w ) continue;
			int n = (y * img.w) + x;
			int m = ((i + cy) * 128) + j + cx;
			if((n < (img.h*img.w)) && (n >= 0))
				img.pixels[n] = font.pixels[m]? font.pixels[m]&fg : bg;
		}
	}
}


void drawText(Img img, Img font, char* text, int x, int y){
	int i  = 0;
	int tx = 0;
	int ty = 0;
	while(text[i]){
		if(text[i] == '\n'){
			ty++;
			tx = 0;
		}else if(text[i] == '\t'){
			tx = (tx + 4) & -4;
		}else{
			drawChar(img, font, text[i], (tx*8)+x, (ty*12)+y);
			tx++;
			if(tx > img.w/8){
				tx = 0;
				ty++;
			}
		}
		i++;
	}
}

void drawTextSize(Img img, Img font, char* text, int x, int y, int len){
	int tx = 0;
	int ty = 0;
	for(int i = 0; i < len; i++){
		if(text[i] == '\n'){
			ty++;
			tx = 0;
		}else if(text[i] == '\t'){
			tx = (tx + 4) & -4;
		}else{
			drawChar(img, font, text[i], (tx*8)+x, (ty*12)+y);
			tx++;
			if(tx > img.w/8){
				tx = 0;
				ty++;
			}
		}
	}
}


void drawTextColor(Img img, Img font, char* text, int x, int y, uint32_t fg, uint32_t bg){
	int i  = 0;
	int tx = 0;
	int ty = 0;
	while(text[i]){
		if(text[i] == '\n'){
			ty++;
			tx = 0;
		}else if(text[i] == '\t'){
			int nx = tx;
			tx = (tx + 4) & -4;
			for(int j = nx; j < tx; j++) drawColorChar(img, font, ' ', (j*8)+x, (ty*12)+y, 0, bg);
		}else{
			drawColorChar(img, font, text[i], (tx*8)+x, (ty*12)+y, fg, bg);
			tx++;
			if(tx > img.w/8){
				tx = 0;
				ty++;
			}
		}
		i++;
	}
}



void drawTextSizeColor(Img img, Img font, char* text, int x, int y, int len, uint32_t fg, uint32_t bg){
	int tx = 0;
	int ty = 0;
	for(int i = 0; i < len; i++){
		if(text[i] == '\n'){
			ty++;
			tx = 0;
		}else if(text[i] == '\t'){
			int nx = tx;
			tx = (tx + 4) & -4;
			for(int j = nx; j < tx; j++) drawColorChar(img, font, ' ', (j*8)+x, (ty*12)+y, 0, bg);
		}else{
			drawColorChar(img, font, text[i], (tx*8)+x, (ty*12)+y, fg, bg);
			tx++;
			if(tx > img.w/8){
				tx = 0;
				ty++;
			}
		}
	}
}



int lineCount(char* txt, int width){
	int x = 0;
	int y = 1;
	int i = 0;
	while(txt[i]){
		if(txt[i] == '\n'){
			x = 0;
			y++;
		}else if(txt[i] == '\v'){
			x = (x + 4) & -4;
		}else{
			x++;
		}
		if(x > width){
			x = 0;
			y++;
		}
		i++;
	}
	return y;
}

int lineCountSize(char* txt, int width, int size){
	int x = 0;
	int y = 1;
	for(int i = 0; i < size; i++){
		if(txt[i] == '\n'){
			x = 0;
			y++;
		}else if(txt[i] == '\v'){
			x = (x + 4) & -4;
		}else{
			x++;
		}
		if(x > width){
			x = 0;
			y++;
		}
	}
	return y;
}



void windowText(Img img, Img font, TextWindow w, char* text, int x, int y){
	int i  = 0;
	int tx = 0;
	int ty = 0;
	while(text[i]){
		if(text[i] == '\n'){
			ty++;
			tx = 0;
		}else if(text[i] == '\t'){
			tx = (tx + 4) & -4;
		}else if((tx >= w.x) && (ty >= w.y) && (tx < w.x+w.w) && (ty < w.y+w.h)){
			drawChar(img, font, text[i], (tx*8)+x, (ty*12)+y);
			tx++;
		}
		i++;
	}
}


void windowTextColor(Img img, Img font, TextWindow w, char* text, int x, int y, uint32_t fg, uint32_t bg){
	int i  = 0;
	int tx = 0;
	int ty = 0;
	while(text[i]){
		if(text[i] == '\n'){
			ty++;
			tx = 0;
		}else if(text[i] == '\t'){
			tx = (tx + 4) & -4;
		}else if((tx >= w.x) && (ty >= w.y) && (tx < w.x+w.w) && (ty < w.y+w.h)){
			drawColorChar(img, font, text[i], (tx*8)+x, (ty*12)+y, fg, bg);
			tx++;
		}
		i++;
	}
}




void drawSpot(Img img, int px, int py, uint32_t c){
	for(int i = 0; i < 3; i++){
		int y = i + py - 1;
		for(int j = 0; j < 3; j++){
			int x = j + px - 1;
			int n = (y * img.w) + x;
			img.pixels[n] = c;
		}
	}
}


void drawStar(Img img, int x, int y, uint32_t c){
	int w = img.w;
	int n = (y * w) + x;
	img.pixels[n  ] = c;
	img.pixels[n+1] = c;
	img.pixels[n-1] = c;
	img.pixels[n+w] = c;
	img.pixels[n-w] = c;
}





TextImg makeTextImg(int h, int w){
	TextImg ret;
	int size	= h * w;
	ret.bg		= malloc(sizeof(uint32_t) * size);
	ret.fg		= malloc(sizeof(uint32_t) * size);
	ret.text	= malloc(sizeof(uint8_t ) * size);
	for(int i = 0; i < size; i++) ret.bg  [i] =  0;
	for(int i = 0; i < size; i++) ret.fg  [i] =  0;
	for(int i = 0; i < size; i++) ret.text[i] = ' ';
	ret.h		= h;
	ret.w		= w;
	return ret;
}


void voidTextImg(TextImg text){
	int size  = text.h * text.w;
	for(int i = 0; i < size; i++) text.bg  [i] =  0;
	for(int i = 0; i < size; i++) text.fg  [i] =  0;
	for(int i = 0; i < size; i++) text.text[i] = ' ';
}


void drawTextImg(Img img, Img font, TextImg text){
	int h = text.h;
	int w = text.w;
	for(int i = 0; i < h; i++)
		for(int j = 0; j < w; j++)
			drawColorChar(img, font, text.text[(i*w)+j], j*8, i*12, text.fg[(i*w)+j], text.bg[(i*w)+j]);
}


void drawTextImgDiff(Img img, Img font, TextImg a, TextImg b){
	int h = a.h;
	int w = a.w;
	for(int i = 0; i < h; i++){
		for(int j = 0; j < w; j++){
			int n = (i*w)+j;
			if((a.text[n] != b.text[n]) || (a.fg[n] != b.fg[n]) || (a.bg[n] != b.bg[n]))
				drawColorCharFlat(img, font, b.text[n], j*8, i*12, b.fg[n], b.bg[n]);
		}
	}
}


void textCenterTextSize(TextImg img, int x, int y, char* txt, int len, int w, uint32_t bg, uint32_t fg){
	if(len < w){
		int diff = (w-len) / 2;
		textTextImgSize(img, x+diff, y, txt, len, bg, fg);
	}else if(len == w){
		textTextImgSize(img, x     , y, txt, len, bg, fg);
	}else{
		txt = &txt[len-w];
		textTextImgSize(img, x     , y, txt, len, bg, fg);
	}
}


void borderTextImg(TextImg img, int h, int w, int rx, int ry, uint32_t c, uint32_t border){
	for(int i = 0; i < h; i++){
		int y = i + ry;
		if((y < 0) || (y >= img.h)) continue;
		for(int j = 0; j < w; j++){
			int x = j + rx;
			if((x < 0) || (x >= img.w)) continue;
			int n = (y*img.w)+x;
			int edge = ((i == 0) || (i == (h-1)) || (j == 0) || (j == (w-1)));
			img.text[n] = ' ';
			img.bg  [n] = edge? border : c;
			img.fg  [n] = 0;
		}
	}
}


void rectTextImg(TextImg text, int rx, int ry, int h, int w, uint32_t fg, uint32_t bg, uint8_t t){
	for(int i = 0; i < h; i++){
		int y = i + ry;
		if((y < 0) || (y >= text.h)) continue;
		for(int j = 0; j < w; j++){
			int x = j + rx;
			if((x < 0) || (x >= text.w)) continue;
			int n = (y * text.w) + x;
			text.bg  [n] = bg;
			text.fg  [n] = fg;
			text.text[n] = t;
		}
	}
}


void textTextImg(TextImg timg, int x, int y, char* text, uint32_t fg, uint32_t bg){
	int i = 0;
	while(text[i]){
		int n = (y * timg.w) + x + i;
		timg.text[n] = text[i];
		timg.fg  [n] = fg;
		timg.bg  [n] = bg;
		i++;
	}
}


void fTextTextImg(TextImg timg, int x, int y, char* text, int scroll, uint32_t fg, uint32_t bg){
	int i  = 0;
	int ln = -scroll;
	int cl = x;
	while(text[i]){
		int n = ((y+ln) * timg.w) + cl;
		if(text[i] == '\n'){
			ln++;
			cl = x-1;
		}else if(ln >= 0){
			timg.text[n] = text[i];
			timg.fg  [n] = fg;
			timg.bg  [n] = bg;
		}
		cl++;
		i ++;
	}
}


void fmtTextTextImg(TextImg timg, int x, int y, char* text, int scroll, uint32_t fg, uint32_t bg){
	int i  = 0;
	int ln = -scroll;
	int cl = x;
	while(text[i]){
		int n = ((y+ln) * timg.w) + cl;
		if(text[i] == '\\'){
			if(text[i+1] == '\\'){
				timg.text[n] = '\\';
				timg.fg  [n] = fg;
				timg.bg  [n] = bg;
			}else{
				switch(text[i+1]){
					case 'r' : fg = 0xff0000; break;
					case 'g' : fg = 0x00ff00; break;
					case 'b' : fg = 0x0000ff; break;
					case 'w' : fg = 0xffffff; break;
					case 'y' : fg = 0x7f7f00; break;
					case 'm' : fg = 0x7f007f; break;
					case 'c' : fg = 0x007f7f; break;
					case 's' : fg = 0xcfcfcf; break;
					case 'k' : fg = 0x000000; break;
					default  : break;
				}
			}
			cl--;
			i ++;
		}else if(text[i] == '\n'){
			ln++;
			cl = x-1;
			if(ln+y >= timg.h) return;
		}else if(ln >= 0){
			timg.text[n] = text[i];
			timg.fg  [n] = fg;
			timg.bg  [n] = bg;
		}
		cl++;
		i ++;
	}
}


void textTextImgSize(TextImg timg, int x, int y, char* text, int size, uint32_t fg, uint32_t bg){
	for(int i = 0; i < size; i++){
		int n = (y * timg.w) + x + i;
		timg.text[n] = text[i];
		timg.fg  [n] = fg;
		timg.bg  [n] = bg;
	}
}


void ctextTextImgSize(TextImg timg, int x, int y, char* text, int size, uint32_t* fg, uint32_t* bg){
	for(int i = 0; i < size; i++){
		int n = (y * timg.w) + x + i;
		timg.text[n] = text[i];
		timg.fg  [n] = fg  [i];
		timg.bg  [n] = bg  [i];
	}
}


void renderTextImgSize(TextImg timg, int x, int y, char* text, int size, uint32_t fg, uint32_t bg){
	int cl     = 0;
	int ln     = 0;
	for(int  i = 0; i < size; i++){
		if(text[i] == '\n'){
			ln++;
			cl = 0;
		}else if(text[i] == '\t'){
			cl = (cl + 4) & -4;
		}else{
			int  n = ((ln+y) * timg.w) + cl + x;
			timg.text[n] = text[i];
			timg.fg  [n] = fg;
			timg.bg  [n] = bg;
			cl++;
		}
	}
}


int charCol(char* text, int size, int ix){
	int cl = 0;
	for(int i = 0; (i < size) && (i < ix); i++){
		if(i == ix) return cl;
		if(text[i] == '\t'){
			cl = (cl + 4) & -4;
		}else if(text[i] != '\n'){
			cl++;
		}else{
			return cl-1;
		}
	}
	return size-1;
}


int closestLinePos(char* text, int size, int ix){
	if(!size) return 0;
	int  last = 0;
	int    cl = 0;
	for(int i = 0; i < size; i++){
		int tmp = cl;
		if(cl > ix) return last;
		if(text[i] == '\t'){
			cl = (cl + 4) & -4;
		}else if(text[i] != '\n'){
			cl++;
		}else{
			return cl-1;	// assume just one line
		}
		last = tmp;
	}
	return cl-1;	// overflowing the line just gives the end of the line
}


int lineWidth(char* text, int size){
	int cl = 0;
	for(int i = 0; i < size; i++){
		if(text[i] == '\t'){
			cl = (cl + 4) & -4;
		}else if(text[i] != '\n'){
			cl++;
		}else{
			return -1;
		}
	}
	return cl;
}


void renderLineImgWindow(TextImg timg, int x, int y, char* text, int size, int offset, int width, uint32_t fg, uint32_t bg){
	int cl = 0;
	for(int i = 0; i < size; i++){
		if (cl >= (offset+width)) return;
		if((cl >=  offset) && (text[i] > ' ')){
			int n = (timg.w * y) + x + cl - offset;
			timg.text[n] = text[i];
			timg.bg  [n] = bg;
			timg.fg  [n] = fg;
		}
		if(text[i] == '\t'){
			cl = (cl + 4) & -4;
		}else if(text[i] != '\n'){
			cl++;
		}else{
			return;	// assume just one line
		}
	}
}







void hilbertRot(int n, int *x, int *y, int rx, int ry) {
    if (ry == 0) {
        if (rx == 1) {
            *x = n-1 - *x;
            *y = n-1 - *y;
        }
        int t  = *x;
        *x = *y;
        *y = t;
    }
}


int unhilbert(int n, int x, int y){
    int rx, ry, s, d = 0;
    for(int s = n/2; s > 0; s /= 2){
        rx = (x & s) > 0;
        ry = (y & s) > 0;
        d += s * s * ((3 * rx) ^ ry);
        hilbertRot(n, &x, &y, rx, ry);
    }
    return d;
}


void hilbert(int n, int d, int *x, int *y){
    int rx, ry, s, t=d;
    *x = *y = 0;
    for(int s = 1; s < n; s *= 2){
        rx = 1 & (t/2);
        ry = 1 & (t ^ rx);
        hilbertRot(s, x, y, rx, ry);
        *x += s * rx;
        *y += s * ry;
        t /= 4;
    }
}






